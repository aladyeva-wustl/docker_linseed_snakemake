---
title: "R Notebook"
output: html_notebook
---

```{r}
library(ComplexHeatmap)
library(data.table)
library(tibble)
library(dplyr)
library(ggplot2)
library(ggalluvial)
library(gridExtra)
```

```{r}
min_ct <- 7
max_ct <- 17
top_genes <- 300
PATH <- "/Volumes/martyomov/Active/IndividualBackUps/aladyevae/deconvolution/data/results/HNSC_TPM_HK_CC_F_LIMITX_OMEGA_MAD_1_KNN_GENES_500_X/09_2022"
DT <- "20221012_171716"
```


```{r}
total.merge <- data.frame(matrix(0,ncol=0,nrow=sum(min_ct:max_ct)))

for (ct in min_ct:max_ct) {
   print(ct)
   
   merged.fisher.test <- NULL
   basis_1 <- fread(file.path(PATH,paste0("ct",ct),DT,"best/basis_column.tsv"))
   props_1  <- as.data.frame(basis_1)[1,colnames(basis_1)[grepl("^Cell_",colnames(basis_1))]]
   basis_1 <- as.data.frame(basis_1[-1,]) %>% tibble::column_to_rownames("V1")
   basis_1 <- basis_1[,colnames(basis_1)[grepl("^FC",colnames(basis_1))]]
 
   for (ct_next in min_ct:max_ct) {
     #ct_next <- ct + 1
     basis_2 <- fread(file.path(PATH,paste0("ct",ct_next),DT,"best/basis_column.tsv"))
     props_2  <- as.data.frame(basis_2)[1,colnames(basis_2)[grepl("^Cell_",colnames(basis_2))]]
     basis_2 <- as.data.frame(basis_2[-1,]) %>% tibble::column_to_rownames("V1")
     basis_2 <- basis_2[,colnames(basis_2)[grepl("^FC",colnames(basis_2))]]
     
     test.res <- matrix(0,ct,ct_next)
     rownames(test.res) <- paste0("ct",ct,"_cell_type_",1:ct,"_",props_1)
     colnames(test.res) <- paste0("ct",ct_next,"_cell_type_",1:ct_next,"_",props_2)
     for (ct1 in 1:ct) {
       group_1 <- rownames((basis_1 %>% arrange(desc(.data[[paste0("FC_Cell_type_",ct1)]])))[1:top_genes,])
       for (ct2 in 1:ct_next) {
         group_2 <- rownames((basis_2 %>% arrange(desc(.data[[paste0("FC_Cell_type_",ct2)]])))[1:top_genes,])
         overlap <- intersect(group_1,group_2)
         total <- nrow(basis_1)  
         p.val <- fisher.test(matrix(c(length(overlap), length(group_2)-length(overlap), length(group_1)-length(overlap), total-length(group_2)-length(group_1)+length(overlap)), 2, 2), alternative='greater')$p.value
         test.res[ct1,ct2] <- p.val
       }
     }
     test.res.log <- round(-log10(test.res),3)
     test.res.log[is.infinite(test.res.log)] <- 308.0
     #test.res.log <- as.data.frame(cbind(ct_next,t(test.res.log)))
     test.res.log <- as.data.frame(t(test.res.log))
     merged.fisher.test <- rbind(merged.fisher.test,test.res.log)
     
   }
   total.merge <- cbind(total.merge,merged.fisher.test)
 }
```

```{r}
filter_proportions <- function(data_,filter_limit=0.01){
  data_ <- data_
  selected_rows <- (sapply(rownames(data_),function(x) {
     split_x <- strsplit(x,"_")[[1]]
     as.numeric(split_x[length(split_x)])
    })>filter_limit)
  selected_cols <- (sapply(colnames(data_),function(x) {
   split_x <- strsplit(x,"_")[[1]]
   as.numeric(split_x[length(split_x)])
  })>filter_limit)
  toPlot <- data_[selected_rows,selected_cols]
}
```


```{r, fig.width=15}
pheatmap(filter_proportions(total.merge),scale="none")
```


write.table(filter_proportions(total.merge),file="/Volumes/martyomov/Active/IndividualBackUps/aladyevae/deconvolution/data/results/HNSC_TPM_HK_CC_F_LIMITX_OMEGA_MAD_1_KNN_GENES_500_X/09_2022/HNSC_TPM_HK_CC_F_LIMITX_OMEGA_MAD_1_KNN_GENES_500_X_merged_ct_filtered.tsv",sep="\t",col.names = NA,quote = F)



